"""
generate_experiment_report_html.py

Generates a single HTML report for an experiment run directory. Embeds image thumbnails
and includes JSON/CSV/log previews.

Usage (PowerShell):
    python .\tools\generate_experiment_report_html.py --dir programmingAssignment2\results\run_20251103_013059

Outputs: `report.html` inside the target dir.
"""
import os
import json
import csv
from datetime import datetime
import argparse
import base64

HTML_TEMPLATE = '''<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Experiment Report - {title}</title>
    <style>
                body {{ font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, 'Helvetica Neue', Arial; background:#f6f8fb; color:#222; margin:0; padding:0; -webkit-font-smoothing:antialiased; }}
                main.container {{ max-width:1200px; margin:24px auto; padding:20px; background:#fff; box-shadow:0 6px 18px rgba(14,20,30,0.06); border-radius:10px; }}
                header {{ margin-bottom:12px; }}
                .controls {{ display:flex; gap:12px; align-items:center; margin:12px 0 18px 0; }}
                /* search-input removed (search bar disabled) */
                .btn {{ padding:8px 12px; border-radius:8px; border:1px solid #e6e9ee; background:#fff; cursor:pointer; box-shadow:0 1px 2px rgba(0,0,0,0.03); text-decoration:none; color:inherit; display:inline-block; }}
                /* Horizontal thumbnail strip that scrolls if needed */
                .grid {{ display:flex; flex-wrap:nowrap; gap:12px; overflow-x:auto; padding:6px 0; }}
                .thumb {{ width:160px; flex:0 0 160px; border:1px solid #f0f2f5; padding:6px; background:#fff; box-shadow:0 1px 3px rgba(0,0,0,0.04); border-radius:6px; }}
                .thumb img {{ width:100%; height:auto; display:block; border-radius:4px; }}
                .thumb a {{ text-decoration:none; color:inherit; }}
                pre {{ background:#fbfcfe; padding:12px; overflow:auto; max-height:360px; border-radius:6px; border:1px solid #f0f2f5; }}
                table {{ border-collapse:collapse; width:100%; border-radius:6px; overflow:hidden; box-shadow:0 1px 2px rgba(0,0,0,0.03); }}
                table th, table td {{ border:1px solid #eee; padding:8px; text-align:left; background:#fff; }}
                .meta {{ margin-bottom:10px; color:#666; }}
                .config-panel {{ border:1px solid #eee; border-radius:8px; padding:10px; margin-bottom:12px; background:linear-gradient(180deg,#ffffff,#fbfdff); }}
                .panel-header {{ display:flex; justify-content:space-between; align-items:center; gap:12px; cursor:pointer; }}
                .panel-header h3 {{ margin:0; font-size:16px; }}
                .panel-body.collapsed {{ display:none; }}
    </style>
    <script>
        // helper: open focused thumbnail with 'f'
        document.addEventListener('keydown', function(e){{
            if(e.key === 'f'){{
                const el = document.activeElement;
                if(el && el.tagName === 'A' && el.dataset && el.dataset.full){{
                    window.open(el.href, '_blank');
                }}
            }}
        }});

    /* All interactive buttons (panel toggles / expand / collapse) have been removed per request. No handlers attached. */
    </script>
</head>
<body>
    <main class="container">
    <header>
        <h1 style="margin:0">Experiment Report â€” {title}</h1>
        <div class="meta">Generated: {generated} UTC | Directory: <code>{dirpath}</code></div>
        <div class="controls">
            <a class="btn" href="#images">Images</a>
            <a class="btn" href="#json">JSON</a>
            <a class="btn" href="#csv">CSV</a>
            <a class="btn" href="#logs">Logs</a>
        </div>
    </header>

    <section>
        <h2>Summary</h2>
        <ul>
            <li>JSON files: {json_count}</li>
            <li>CSV files: {csv_count}</li>
            <li>Image files: {img_count}</li>
            <li>Log files: {log_count}</li>
        </ul>
    </section>

        {connected_section}

    {json_section}
    {csv_section}
    {images_section}
    {logs_section}

  <footer style="margin-top:30px;color:#666">Report generated by generate_experiment_report_html.py</footer>
</body>
</html>
'''


def read_json(path):
    try:
        with open(path, 'r', encoding='utf-8') as f:
            return json.load(f)
    except Exception as e:
        return {'_error': str(e)}


def read_csv_preview(path, rows=10):
    try:
        with open(path, 'r', encoding='utf-8') as f:
            rdr = csv.reader(f)
            out = []
            for i, r in enumerate(rdr):
                out.append(r)
                if i + 1 >= rows:
                    break
            return out
    except Exception as e:
        return [{'_error': str(e)}]


def tail_file(path, n_lines=200):
    try:
        with open(path, 'rb') as f:
            f.seek(0, os.SEEK_END)
            end = f.tell()
            size = 1024
            data = b''
            while end > 0 and data.count(b'\n') <= n_lines:
                start = max(0, end - size)
                f.seek(start)
                chunk = f.read(end - start)
                data = chunk + data
                end = start
                size *= 2
            text = data.decode('utf-8', errors='replace')
            lines = text.splitlines()
            return '\n'.join(lines[-n_lines:])
    except Exception as e:
        return f'Could not read log: {e}'


def build_json_section(json_files, target_dir):
    if not json_files:
        return ''
    parts = ['<section id="json"><h2>JSON Files</h2>']
    for jf in json_files:
        path = os.path.join(target_dir, jf)
        data = read_json(path)
        parts.append(f'<h3>{jf}</h3>')
        parts.append('<pre>')
        try:
            parts.append(json.dumps(data, indent=2, default=str))
        except Exception:
            parts.append(str(data))
        parts.append('</pre>')
    parts.append('</section>')
    return '\n'.join(parts)


def build_csv_section(csv_files, target_dir):
    if not csv_files:
        return ''
    parts = ['<section id="csv"><h2>CSV Files</h2>']
    for cf in csv_files:
        path = os.path.join(target_dir, cf)
        preview = read_csv_preview(path, rows=20)
        parts.append(f'<h3>{cf}</h3>')
        parts.append('<table>')
        for i, r in enumerate(preview):
            if isinstance(r, dict) and '_error' in r:
                parts.append(f'<tr><td colspan="100">Error reading CSV: {r["_error"]}</td></tr>')
                continue
            parts.append('<tr>' + ''.join(f'<td>{html_escape(cell)}</td>' for cell in r) + '</tr>')
        parts.append('</table>')
    parts.append('</section>')
    return '\n'.join(parts)


def html_escape(s):
    if s is None:
        return ''
    return (str(s).replace('&', '&amp;').replace('<', '&lt;').replace('>', '&gt;').replace('\n','<br/>'))


def build_images_section(img_files, target_dir, embed=False):
    if not img_files:
        return ''
    parts = ['<section id="images"><h2>Images</h2>','<div class="grid">']
    for img in img_files:
        src = img
        if embed:
            # read the image and embed as base64 data-uri
            try:
                p = os.path.join(target_dir, img)
                with open(p, 'rb') as f:
                    b = f.read()
                mimetype = 'image/png'
                if img.lower().endswith('.jpg') or img.lower().endswith('.jpeg'):
                    mimetype = 'image/jpeg'
                data = base64.b64encode(b).decode('ascii')
                src = f'data:{mimetype};base64,{data}'
            except Exception:
                src = img
        # open full-size in new tab; add data-full attr for optional keyboard shortcuts
        parts.append(f'<div class="thumb"><a href="{src}" target="_blank" data-full="1"><img src="{src}" alt="{img}"/></a><div style="font-size:0.8em;margin-top:6px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">{img}</div></div>')
    parts.append('</div></section>')
    return '\n'.join(parts)


def build_logs_section(log_files, target_dir):
    if not log_files:
        return ''
    parts = ['<section id="logs"><h2>Logs (tail)</h2>']
    for lf in log_files:
        path = os.path.join(target_dir, lf)
        tail = tail_file(path, n_lines=300)
        parts.append(f'<h3>{lf}</h3>')
        parts.append('<pre>')
        parts.append(html_escape(tail))
        parts.append('</pre>')
    parts.append('</section>')
    return '\n'.join(parts)


def find_csv_row(csv_files, target_dir, config):
    # try to find a CSV row matching env, algo, exploration
    if not csv_files:
        return None
    key_fields = (config.get('algo') or config.get('algorithm'), config.get('env_type'))
    for cf in csv_files:
        path = os.path.join(target_dir, cf)
        try:
            with open(path, 'r', encoding='utf-8') as f:
                reader = csv.reader(f)
                headers = next(reader, None)
                for row in reader:
                    # look for algo and env in the row text
                    row_txt = ','.join(row)
                    if key_fields[0] and key_fields[1] and key_fields[0] in row_txt and key_fields[1] in row_txt:
                        return {'csv_file': cf, 'row': row, 'headers': headers}
        except Exception:
            continue
    return None


def build_connected_view(target_dir, json_files, csv_files, img_files, embed=False):
    # Read main JSON (all_results.json) if present
    if not json_files:
        return ''
    main_json = None
    for jf in json_files:
        if jf.lower().startswith('all_results'):
            main_json = read_json(os.path.join(target_dir, jf))
            break
    if main_json is None:
        # fallback to first json
        main_json = read_json(os.path.join(target_dir, json_files[0]))

    parts = ['<section><h2>Configurations & Linked Artifacts</h2>']

    summary_rows = []
    for idx, entry in enumerate(main_json):
        cfg = entry.get('config', {})
        bp = entry.get('best_params', {})
        algo = cfg.get('algo') or cfg.get('algorithm') or ''
        envt = cfg.get('env_type') or cfg.get('env') or ''
        exploration = cfg.get('exploration') or ''
        cfg_idx = cfg.get('config_idx') or (idx + 1)

        # render a semantic panel that the page JS can filter/collapse
        parts.append(f"<div class=\"config-panel\">")
        parts.append(f"<div class=\"panel-header\"><h3>{idx+1}. {html_escape(algo)} / {html_escape(envt)} / {html_escape(exploration)}</h3></div>")
        parts.append(f"<div id=\"panel-body-{idx}\" class=\"panel-body\">")
        parts.append('<div style="display:flex;gap:12px">')

        # left: params
        parts.append('<div style="flex:1;min-width:320px">')
        parts.append('<h4>Config</h4>')
        parts.append('<pre>')
        parts.append(html_escape(json.dumps(cfg, indent=2, default=str)))
        parts.append('</pre>')
        parts.append('<h4>Best params</h4>')
        parts.append('<pre>')
        parts.append(html_escape(json.dumps(bp, indent=2, default=str)))
        parts.append('</pre>')

        # try to find matching CSV row
        csv_match = find_csv_row(csv_files, target_dir, cfg)
        if csv_match:
            parts.append(f"<h4>CSV ({csv_match['csv_file']})</h4>")
            parts.append('<pre>')
            parts.append(html_escape(', '.join(map(str, csv_match.get('row', [])))))
            parts.append('</pre>')

        parts.append('</div>')

        # right: images
        parts.append('<div style="flex:1;min-width:320px">')
        parts.append('<h4>Linked images</h4>')
        # Prefer exact tag that includes the config index used when images were saved
        # try both forms: with or without an exploration token in the filename
        if exploration:
            exact_tag = f"{algo}_{envt}_{exploration}_{cfg_idx}"
            exact_tag_alt = f"{algo}_{envt}__{cfg_idx}"  # handle older double-underscore style
        else:
            exact_tag = f"{algo}_{envt}_{cfg_idx}"
            exact_tag_alt = f"{algo}_{envt}__{cfg_idx}"
        # also accept filenames that contain _{cfg_idx}_ or __{cfg_idx}_ as a robust delimiter-aware match
        matched = [im for im in img_files if (exact_tag in im or exact_tag_alt in im or f"_{cfg_idx}_" in im or f"__{cfg_idx}_" in im)]
        # fallback: match images that contain algo_env_exploration tokens (less specific)
        if not matched:
            token = f"{algo}_{envt}_{exploration}" if exploration else f"{algo}_{envt}"
            matched = [im for im in img_files if token in im]
        # fallback 2: match by algo and env only
        if not matched:
            matched = [im for im in img_files if (algo in im and envt in im)]

        if matched:
            # show matched images as a horizontal strip of small thumbnails
            parts.append('<div class="grid">')
            for im in matched:
                src_im = im
                if embed:
                    try:
                        p = os.path.join(target_dir, im)
                        with open(p, 'rb') as f:
                            b = f.read()
                        mimetype = 'image/png'
                        if im.lower().endswith('.jpg') or im.lower().endswith('.jpeg'):
                            mimetype = 'image/jpeg'
                        data = base64.b64encode(b).decode('ascii')
                        src_im = f'data:{mimetype};base64,{data}'
                    except Exception:
                        src_im = im
                parts.append(f'<div class="thumb"><a href="{src_im}" target="_blank" data-full="1"><img src="{src_im}" style="max-width:100%;border:1px solid #ccc"/></a><div style="font-size:0.8em;margin-top:6px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">{im}</div></div>')
            parts.append('</div>')
        else:
            parts.append('<div style="color:#666">No matching images found.</div>')

        parts.append('</div>')
        parts.append('</div>')
        parts.append('</div>')

        # collect summary
        final_reward = bp.get('final_reward') if isinstance(bp, dict) else None
        summary_rows.append({'idx': idx+1, 'algo': algo, 'env': envt, 'exploration': exploration, 'final_reward': final_reward})

    # final summary table sorted by final_reward
    parts.append('<h2>Final summary (sorted by final_reward)</h2>')
    parts.append('<table><tr><th>#</th><th>algo</th><th>env</th><th>exploration</th><th>final_reward</th></tr>')
    def sort_key(r):
        v = r.get('final_reward')
        return float('inf') if v is None else float(v)
    for r in sorted(summary_rows, key=sort_key):
        parts.append(f"<tr><td>{r['idx']}</td><td>{html_escape(r['algo'])}</td><td>{html_escape(r['env'])}</td><td>{html_escape(r['exploration'])}</td><td>{r['final_reward']}</td></tr>")
    parts.append('</table>')

    parts.append('</section>')
    return '\n'.join(parts)


def main(target_dir, outname='report.html', embed=False):
    files = sorted(os.listdir(target_dir))
    json_files = [f for f in files if f.lower().endswith('.json')]
    csv_files = [f for f in files if f.lower().endswith('.csv')]
    img_files = [f for f in files if f.lower().endswith('.png') or f.lower().endswith('.jpg') or f.lower().endswith('.jpeg')]
    log_files = [f for f in files if f.lower().endswith('.txt')]

    json_section = build_json_section(json_files, target_dir)
    csv_section = build_csv_section(csv_files, target_dir)
    images_section = build_images_section(img_files, target_dir, embed=embed)
    logs_section = build_logs_section(log_files, target_dir)

    # build connected view: link json entries to csv and images
    connected_section = build_connected_view(target_dir, json_files, csv_files, img_files, embed=embed)

    html = HTML_TEMPLATE.format(
        title=os.path.basename(target_dir),
        generated=datetime.utcnow().isoformat(),
        dirpath=target_dir,
        json_count=len(json_files),
        csv_count=len(csv_files),
        img_count=len(img_files),
        log_count=len(log_files),
        json_section=json_section,
        csv_section=csv_section,
        images_section=images_section,
        logs_section=logs_section,
        connected_section=connected_section
    )

    out_path = os.path.join(target_dir, outname)
    with open(out_path, 'w', encoding='utf-8') as f:
        f.write(html)
    print(f'Wrote HTML report to {out_path}')


if __name__ == '__main__':
    parser = argparse.ArgumentParser()
    parser.add_argument('--dir', default='experiment_results', help='target results directory')
    parser.add_argument('--out', default='report.html', help='output html filename inside target dir')
    parser.add_argument('--embed', action='store_true', help='embed images into the single-file html (base64)')
    args = parser.parse_args()
    target = args.dir
    if not os.path.isdir(target):
        raise SystemExit(f'Target dir not found: {target}')
    main(target, outname=args.out, embed=bool(args.embed))
